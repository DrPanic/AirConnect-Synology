#!/bin/sh

set -eu

AIRCONNECT_DIR="/var/packages/AirConnect/target"

logfile=/tmp/airupnp.log

start_airupnp ()
{
    ip="$1"
    port=49154
    echo "[$(date +'%T')] Starting airupnp on ${ip}:${port}" >> ${logfile}

    su airconnect -s /bin/sh -c "${AIRCONNECT_DIR}/airupnp -b ${ip}:${port} -z -l 1000:2000 -f ${logfile} -d all=error -d main=info" >> ${logfile} 2>&1

    cnt=0
    while [ $cnt -lt 5 ]; do
        if grep -q "adding renderer" ${logfile}; then
            return 0
        fi
        cnt=$((cnt + 1))
        sleep 1
    done
    return 1
}

start_airconnect ()
{
    touch "${logfile}"
    chown airconnect:users "${logfile}"
    true > $logfile

    # If you want to start the airupnp process on a custom IP please uncomment the following lines
    # and set your own local IP address:
    #
    # start_airupnp "1.2.3.4" || true
    # return  0

    ips=$(ifconfig -a | grep 'Ethernet' -A 1 | grep -Eo 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -Eo '([0-9]*\.){3}[0-9]*')

    if [ -z "$ips" ]; then
        echo "Failed to get the Ethernet interfaces" > "${SYNOPKG_TEMP_LOGFILE}"
        exit 1
    fi

    started=0
    ip=$(echo "${ips}" | grep -E "^192\\.168\\." | head -n 1)
    if [ -n "$ip" ]; then
        if start_airupnp "$ip"; then
            started=1
        fi
    fi

    if [ $started != 1 ]; then
        ip=$(echo "${ips}" | grep -E "^10\\." | head -n 1)
        if [ -n "$ip" ]; then
            if start_airupnp "$ip"; then
                started=1
            fi
        fi
    fi

    if [ $started != 1 ]; then
        echo "Failed to start airupnp on any of the Ethernet interfaces (10.* or 192.168.*)" > "${SYNOPKG_TEMP_LOGFILE}"
        exit 1
    fi
}

stop_airconnect ()
{
    killall -15 airupnp
}

airconnect_status ()
{
    # Check if ps has ax options
    if ps ax >/dev/null 2>&1; then
        # shellcheck disable=SC2009
        if ! ps ax | grep airupnp | grep -v -q grep; then
            return 1
        fi
    else
        # shellcheck disable=SC2009
        if ! ps | grep airupnp | grep -v -q grep; then
            return 1
        fi
    fi

    return 0
}

case $1 in
    start)
        echo Starting AirConnect ...
        start_airconnect
        exit $?
        ;;
    stop)
        echo Stopping AirConnect ...
        stop_airconnect
        exit $?
        ;;
    status)
        if airconnect_status
        then
            echo AirConnect is running
            exit 0
        else
            echo AirConnect is not running
            exit 1
        fi
        ;;
    log)
        echo "/tmp/airupnp.log"
        exit 0
        ;;
    *)
        exit 1
        ;;
esac
